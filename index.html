<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html;charset=utf-8">
    <title>line of sight test</title>
    <script type="text/javascript" src="../vendor/jquery.min.js"></script>
    <script type="text/javascript" src="../vendor/raphael.min.js"></script>
    <script type="text/javascript">
      var paper,
          map_width,
          map_height,
          map,
          hero;
      jQuery(document).ready(function(){
        var canvas_elem = jQuery('#canvas');
        paper = Raphael('canvas',canvas_elem.width(),canvas_elem.height());
        MainScene();
      });
      var MainScene = function(){
        var tile_size = 8;
        map = [];
        map_width = Math.floor(paper.width / tile_size);
        map_height = Math.floor(paper.height / tile_size);
        hero = {'x':Math.floor(map_width / 2),'y':Math.floor(map_height / 2)};
        Background(0,0,paper.width,paper.height,'#B3C69C');
        // generate clean map
        var tile;
        for(var y = 0, yl = map_height, x, xl = map_width; y < yl; y += 1){
          map[y] = [];
          for(x = 0; x < xl; x += 1){
            tile = Tile(x * tile_size,y * tile_size,tile_size,'rgba(33,36,43,1)',true);
            map[y][x] = tile;
          };
        };
        // add some obstacles to map
        for(var q = 0, ql = 40; q < ql; q += 1){
          var x = Math.floor(Math.random() * map_width),
              y = Math.floor(Math.random() * map_height);
          for(var i = 0, il = 2; i < il; i++){
            for(var j = 0; j < il; j++){
              if(y + i < map.length && x + j < map[0].length){
                tile = map[y + i][x + j];
                tile.attr('fill','rgba(33,36,43,1)');
                tile.walkable = false;
              };
            };
          };
        };
        var move_character = function(e){
          if(e.keyCode === 37 || e.keyCode === 38 || e.keyCode === 39 || e.keyCode === 40){
            for(var m = 0; m < map_height; m++){
              for(var n = 0; n < map_width; n++){
                map[m][n].visible = true;
              };
            };
            if(hero.tile !== undefined){
              hero.tile.attr('fill','rgba(100,109,95,1)');
            };
            if(e.keyCode === 37 && hero.x - 1 > -1 && map[hero.y][hero.x - 1].walkable){
              hero.x -= 1;
            };
            if(e.keyCode === 38 && hero.y - 1 > -1 && map[hero.y - 1][hero.x].walkable){
              hero.y -= 1;
            };
            if(e.keyCode === 39 && hero.x + 1 < map_width && map[hero.y][hero.x + 1].walkable){
              hero.x += 1;
            };
            if(e.keyCode === 40 && hero.y + 1 < map_height && map[hero.y + 1][hero.x].walkable){
              hero.y += 1;
            };
            illuminate(hero.x,hero.y);
            hero.tile = map[hero.y][hero.x];
            hero.tile.toFront();
            hero.tile.attr('fill','rgba(220,230,194,1');
          };
        };
        jQuery(document).keydown(move_character);
        move_character({'keyCode':40});
      };
      var illuminate = function(center_x,center_y){
        var is_visible,
            tile;
        for(var y = 0, yl = map.length, x, xl = map[0].length; y < yl; y += 1){
          for(x = 0; x < xl; x += 1){
            is_visible = check_visibility(center_x,center_y,x,y);
            tile = map[y][x];
            if(is_visible){
              // fancy coloring
              var rd = 100 - 33,
                  gd = 109 - 36,
                  bd = 95 - 43,
                  rb = 100,
                  gb = 109,
                  bb = 95;
              var dx = center_x - x,
                  dy = center_y - y,
                  d = Math.sqrt((dx * dx) + (dy * dy)) / 25,
                  rn = ~~(rb - (rd * d)),
                  gn = ~~(gb - (gd * d)),
                  bn = ~~(bb - (bd * d));
              if(rn < 33) rn = 33;
              if(gn < 36) gn = 36;
              if(bn < 43) bn = 43;
              tile.attr('fill','rgba(' + [rn,gn,bn,1].join(',') + ')');
              tile.visible = true;
            }else{
              tile.attr('fill','rgba(33,36,43,1)');
              tile.visible = false;
            };
          };
        };
        for(var y = 0, yl = map.length, x, xl = map[0].length; y < yl; y += 1){
          for(x = 0; x < xl; x += 1){
            tile = map[y][x];
            if(tile.walkable){
            }else{
              var first_visible = check_visibility(center_x,center_y,x,y);
              if(first_visible){
                // fancy coloring
                var rd = 57 - 33,
                    gd = 77 - 36,
                    bd = 61 - 43,
                    rb = 57,
                    gb = 77,
                    bb = 61;
                var dx = center_x - x,
                    dy = center_y - y,
                    d = Math.sqrt((dx * dx) + (dy * dy)) / 25,
                    rn = ~~(rb - (rd * d)),
                    gn = ~~(gb - (gd * d)),
                    bn = ~~(bb - (bd * d));
                if(rn < 33) rn = 33;
                if(gn < 36) gn = 36;
                if(bn < 43) bn = 43;
                tile.attr('fill','rgba(' + [rn,gn,bn,1].join(',') + ')');
                //tile.attr('fill','rgba(57,77,61,1)');
              }else{
                tile.attr('fill','rgba(33,36,43,1)');
              };
            };
          };
        };
      };
      var check_visibility = function(x0,y0,x1,y1){
        var dx = Math.abs(x1 - x0),
            dy = Math.abs(y1 - y0),
            sx = x0 < x1 ? 1 : 0 - 1,
            sy = y0 < y1 ? 1 : 0 - 1,
            err = dx - dy;
        while(true){
          if(x0 === x1 && y0 === y1) break;
          if(x0 > 0 && x0 < map_width && y0 > 0 && y0 < map_height){
            if(map[y0][x0].walkable === false || map[y0][x0].visible === false){
              return false;
            };
          };
          var e2 = 2 * err;
          if(e2 > 0 - dy){
            err -= dy;
            x0 += sx;
          };
          if(e2 < dx){
            err += dx;
            y0 += sy;
          };
        };
        return true;
      };
      var Tile = function(x,y,size,fill,walkable){
        var rect = paper.rect(x,y,size,size);
        rect.attr('fill',fill);
        rect.attr('stroke-width',0);
        rect.walkable = walkable;
        rect.visible = true;
        return rect;
      };
      var Background = function(x,y,width,height,fill){
        var rect = paper.rect(x,y,width,height);
        rect.attr('fill',fill);
        rect.attr('stroke-width',0);
      };
    </script>
    <style type="text/css">
      html,
      body {
        background-color:#E1E1E1;
      }
      #canvas {
        width:480px;
        height:320px;
        margin:0 auto;
      }
    </style>
  </head>
  <body>
    <div id="canvas"></div>
  </body>
</html>
